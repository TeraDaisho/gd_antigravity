---
name: repo-security-auditor
description: GitHubリポジトリやパッケージ導入前の総合セキュリティ評価ガイド。多層防御フレームワークに基づき、開発者の信頼性、コードの悪意あるパターン（Semgrepロジック）、インフラ権限、サプライチェーン成熟度を定量的・定性的に監査します。
---

# Repository Security Auditor (repo-security-auditor)

GitHubリポジトリやnpm/PyPIパッケージ、Agent Skillをプロジェクトに導入する前に、その安全性と信頼性を包括的に監査し、「攻撃者の意図」を見抜くための専門スキルです。
本チェックリストは、単純な脆弱性スキャンを超え、多層防御（Defense in Depth）の観点から厳格なリスク評価を行います。

## 監査チェックリスト

以下のカテゴリ（A〜E）について検証を行い、レポートを作成してください。

### カテゴリA：信頼性（Reputation & Metadata）

開発者とプロジェクトの社会的信頼性を評価し、偽装や即席のアカウントを排除します。

- [ ] **アカウントの成熟度**: 開発者のGitHubアカウント作成から**48時間以上**経過しているか確認してください。
- [ ] **Verified Status**: 可能な場合、GitHubのVerifiedバッジや、組織の公式サイトとのリンクを確認してください。
- [ ] **活動と評価の整合性**: スター数に対し、アクティビティ（Commit/Issue）が極端に少ない、または特定の短期間に急増している等の不整合がないか確認してください（Star Farmingの検知）。
- [ ] **コミット履歴の連続性**: 異なるメールアドレスや署名が混在するなど、コミット履歴に不自然な断絶や矛盾がないか確認してください。

### カテゴリB：コードの健全性・静的振る舞い分析（Static Behavioral Analysis）

ソースコード解析を行い、悪意ある「意図」と「挙動」を特定します。Semgrep等のSASTツールのロジックを応用してチェックします。

- [ ] **危険な関数の組み合わせ (JS/TS)**:
    - `eval(atob(...))` や `new Function(...)` など、難読化解除と動的実行を組み合わせたパターンがないか。
    - `process.env` をシリアライズして外部送信するようなコードがないか。
    - `obfuscator.io` 等の特徴的な難読化パターンが含まれていないか。
- [ ] **危険な関数の検知 (Python)**:
    - 信頼できない入力を伴う `exec(...)` や `eval(...)` の使用がないか。
- [ ] **ライフサイクルスクリプト**: `preinstall`, `postinstall` 等で `curl`, `wget` による外部通信や、環境変数（`/etc/shadow` 等）へのアクセス試行がないか。
- **推奨**: インストール時は可能な限り `--ignore-scripts` を使用することを推奨文に含めてください。

### カテゴリC：Action & インフラ（CI/CD & Permissions）

CI/CD環境（GitHub Actions）の堅牢性を評価し、パイプライン攻撃を防ぎます。

- [ ] **Actionインジェクション対策**: `pull_request_target` トリガーを使用している場合、チェックアウトされたコードに対して危険な操作（ビルド、テスト実行など）が行われていないか厳重に確認してください。
- [ ] **Actionのピン留め**: サードパーティ製Actionは、タグ（v1等）ではなく**フルレングスのコミットSHA**で固定されているか確認してください。
- [ ] **権限の最小化**: `permissions` ブロックで `contents: read` など、必要最小限の権限が明示されているか確認してください（`Default Deny` の原則）。

### カテゴリD：サプライチェーンの完全性（Supply Chain Integrity）

プロジェクトの構成管理とガバナンス体制を評価します。

- [ ] **ロックファイルの存在**: `package-lock.json`, `yarn.lock`, `poetry.lock` 等が含まれており、依存関係が固定されているか確認してください。
- [ ] **OSSF Scorecard**: プロジェクトのスコアが **7.0以上** であることが望ましいです。署名付きコミット、ブランチ保護、依存関係更新の自動化（Dependabot等）が実施されているか評価してください。
- [ ] **SBOM**: Software Bill of Materials (SBOM) の生成や管理が行われている形跡があるか確認してください。

### カテゴリE：ランタイム隔離（Runtime Isolation）

**CRITICAL** または **HIGH** リスクの可能性があるコード、あるいは信頼性が完全に確立されていないコードを実行/テストする必要がある場合、以下の環境での実行を強く推奨します。

- **gVisor / Firecracker**: コンテナをカーネルレベルで隔離する技術を使用する。
- **Ephemeral Environments**: 実行ごとに破棄される使い捨てのサンドボックス環境を使用する。

## 判定ロジック（重み付けアルゴリズム）

1. **CRITICAL (即時遮断 - 導入禁止)**
    *   難読化コード + 外部への不正通信の痕跡がある。
    *   環境変数を外部送信（Exfiltration）するコードが含まれている。
    *   ライフサイクルスクリプトで不審なOSコマンド（`/etc/shadow`へのアクセス等）が実行されている。

2. **HIGH (詳細レビュー必須 / 原則禁止)**
    *   アカウント作成から48時間未満。
    *   `pull_request_target` の不適切な使用によるインジェクションリスク。
    *   MFA無効化や特権昇格を試みる挙動の痕跡。
    *   **対処**: セキュリティ専門家によるコード全行レビュー合格まで導入保留。

3. **MEDIUM (要注意 - 条件付き導入)**
    *   OSSF Scorecard < 7.0。
    *   ロックファイルが存在しない。
    *   ActionがSHAピン留めされていない。
    *   **対処**: リスクを受容した上で、フォークして修正版を使用するか、隔離環境（gVisor等）でのみ実行する。

4. **LOW (導入可)**
    *   上記の重大なリスクがなく、開発プロセスが透明で健全。

## 出力フォーマット

```markdown
# セキュリティ監査レポート: [リポジトリ名/パッケージ名]

## 判定: [CRITICAL / HIGH / MEDIUM / LOW]

## サマリー
(判定理由の要約)

## 多層防御チェック結果

### A. 信頼性 (Reputation)
- [ ] アカウント成熟度 (>48h): ...
- [ ] Commits/Stars整合性: ...

### B. コード健全性 (behavioral Analysis)
- [ ] Dynamic Execution (eval/exec): ...
- [ ] Obfuscation (atob/hex): ...
- [ ] Install Scripts: ...

### C. インフラ (CI/CD)
- [ ] Action Injection (pr_target): ...
- [ ] SHA Pinning: ...

### D. サプライチェーン (Integrity)
- [ ] Lockfiles: ...
- [ ] OSSF Scorecard (Target: 7.0+): ...

## 推奨アクション & ポリシー適用
(導入可否、--ignore-scriptsの使用推奨、隔離環境の利用など)
```
